<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>工程化：Rollup 构建 | 曜灵（SUN）Site</title><meta name=keywords content="工程化,Rollup"><meta name=description content="Rollup是一个用于JavaScript的模块打包工具，使用JavaScript的ES6版本中包含的新标准化代码模块格式，而不是以前的CommonJS和AMD等特殊解决方案。让你像ES 模块一样，在所有场景获得原生支持，自由无缝地组合你最喜欢的库中最有用的个别函数&mldr;"><meta name=author content="曜灵"><link rel=canonical href=https://lianpf.github.io/posts/frontend-develop/engine-rollup-config/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://lianpf.github.io/img-common/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://lianpf.github.io/img-common/favicon.png><link rel=icon type=image/png sizes=32x32 href=https://lianpf.github.io/img-common/favicon.png><link rel=apple-touch-icon href=https://lianpf.github.io/img-common/avatar.jpeg><link rel=mask-icon href=https://lianpf.github.io/img-common/avatar.jpeg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script defer src=https://unpkg.com/mermaid@8.8.1/dist/mermaid.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script>
<script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="工程化：Rollup 构建"><meta property="og:description" content="Rollup是一个用于JavaScript的模块打包工具，使用JavaScript的ES6版本中包含的新标准化代码模块格式，而不是以前的CommonJS和AMD等特殊解决方案。让你像ES 模块一样，在所有场景获得原生支持，自由无缝地组合你最喜欢的库中最有用的个别函数&mldr;"><meta property="og:type" content="article"><meta property="og:url" content="https://lianpf.github.io/posts/frontend-develop/engine-rollup-config/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-27T19:36:15+08:00"><meta property="article:modified_time" content="2024-08-27T19:36:15+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="工程化：Rollup 构建"><meta name=twitter:description content="Rollup是一个用于JavaScript的模块打包工具，使用JavaScript的ES6版本中包含的新标准化代码模块格式，而不是以前的CommonJS和AMD等特殊解决方案。让你像ES 模块一样，在所有场景获得原生支持，自由无缝地组合你最喜欢的库中最有用的个别函数&mldr;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://lianpf.github.io/posts/"},{"@type":"ListItem","position":2,"name":"👨🏻‍💻 前端","item":"https://lianpf.github.io/posts/frontend-develop/"},{"@type":"ListItem","position":3,"name":"工程化：Rollup 构建","item":"https://lianpf.github.io/posts/frontend-develop/engine-rollup-config/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"工程化：Rollup 构建","name":"工程化：Rollup 构建","description":"Rollup是一个用于JavaScript的模块打包工具，使用JavaScript的ES6版本中包含的新标准化代码模块格式，而不是以前的CommonJS和AMD等特殊解决方案。让你像ES 模块一样，在所有场景获得原生支持，自由无缝地组合你最喜欢的库中最有用的个别函数\u0026hellip;\n","keywords":["工程化","Rollup"],"articleBody":"Rollup是一个用于JavaScript的模块打包工具，使用JavaScript的ES6版本中包含的新标准化代码模块格式，而不是以前的CommonJS和AMD等特殊解决方案。让你像ES 模块一样，在所有场景获得原生支持，自由无缝地组合你最喜欢的库中最有用的个别函数…\n系列文章：\n第一篇：工程化: babel的一些常见问题 第二篇：工程化：Rollup 构建 第二篇：工程化：@vue/cli 和 Webpack 构建 一、安装使用 作为 全局命令行工具 使用\n$ npm install --global rollup 二、基础示例 场景描述：利用ES MODULE机制，封装了一个@js/sdk包。其中，要求对于?.类似语法，进行ES5的编译处理。@js/sdk具体要求如下:\nsdk/src/index.js导出如下： export { modelA, modelB, // ... } from './zmini/index' sdk/src/utils/util.js等使用?.语法文件，进行编译： const resError = { platform, code: error?.code, errorCode: error?.subCode, message: error?.message } 前期主要利用bable，进行构建，所以需要兼容bable相关逻辑。历史package.json核心如下： { \"scripts\": { \"build\": \"babel src -d lib\" // 构建命令 }, \"devDependencies\": { \"@babel/cli\": \"^7.23.4\", // babel 依赖 \"@babel/core\": \"^7.23.5\", \"@babel/preset-env\": \"^7.23.5\" } } 1.安装依赖和文件配置 1.1 安装依赖 安装必要的依赖包：\n$ npm install --save-dev rollup @rollup/plugin-node-resolve @rollup/plugin-commonjs @rollup/plugin-babel @rollup/plugin-terser @babel/core @babel/preset-env @rollup/plugin-node-resolve: 允许 Rollup 查找并打包 node_modules 中的模块。 @rollup/plugin-commonjs: 使 Rollup 可以转换 CommonJS 模块为 ES6 模块。 @rollup/plugin-babel: 集成 Babel 以便处理现代 JavaScript 语法，并将其转换为支持更老的环境（如 Node.js 12+）的代码。 @rollup/plugin-terser: 用于压缩输出的代码，以减小打包后的体积。 babel.config.js: 配置 Babel，使其使用 @babel/preset-env 来根据目标环境编译代码，并使用 core-js 自动引入 polyfill 以支持可选链语法和其他现代 JavaScript 特性。 1.2 Rollup 配置文件 创建一个 rollup.config.js 文件，内容如下：\nimport resolve from '@rollup/plugin-node-resolve'; import commonjs from '@rollup/plugin-commonjs'; import babel from '@rollup/plugin-babel'; import { terser } from '@rollup/plugin-terser'; // import terser from '@rollup/plugin-terser'; // 某些版本是默认导出 export default { input: 'src/index.js', // 入口文件 output: [ // { // file: 'lib/bundle.cjs.js', // CommonJS 输出 // format: 'cjs', // sourcemap: true, // }, { file: 'lib/bundle.esm.js', // ES Module 输出 format: 'es', sourcemap: true, } ], external: ['@js/base-sdk'], // 忽略package.json中的依赖，避免被打包到libs plugins: [ resolve(), // 解析模块 commonjs(), // 处理 CommonJS 模块 babel({ babelHelpers: 'bundled', exclude: 'node_modules/**', // 只编译我们的源码 presets: [ [ '@babel/preset-env', { targets: { node: '12', // 确保支持 node 12+ }, useBuiltIns: 'usage', corejs: 3, // 自动引入 polyfill }, ], ], }), terser() // 代码压缩 ], }; 1.3 Babel 配置文件 创建一个 .babelrc 或 babel.config.js 文件配置Babel，确保编译目标支持较老的 Node.js 环境：\n{ \"presets\": [ [ \"@babel/preset-env\", { \"targets\": { \"node\": \"12\" }, \"useBuiltIns\": \"usage\", \"corejs\": 3 } ] ] } 2.构建命令 在你的 sdk/package.json 中，更新 scripts 部分，使用 Rollup 构建你的包：\n{ \"type\": \"module\", // 第一种方式：使用 main 和 module 两个配置 // \"main\": \"./lib/bundle.cjs.js\", // CommonJS 入口 // \"module\": \"./lib/bundle.esm.js\", // ES Module 入口 // 第二种：只使用main —— 推荐这种 \"main\": \"./lib/bundle.esm.js\", // 入口配置ES Module \"scripts\": { \"build\": \"rollup -c\" } } 终端运行以下命令来构建你的 SDK 包：\n$ npm run build 构建完成后，生成的文件将在 lib/ 目录下，分别以 CommonJS 和 ES Module 格式输出。这些文件将兼容 Node.js 12 及更高版本。\n三、常见问题 1. 想要在node 16环境下，使用rollup构建，请问我要如何处理？ 异常如下：\nlianpf@lianpf-PC:~/xxx/@js/sdk$ npm install --save-dev rollup @rollup/plugin-node-resolve @rollup/plugin-commonjs @rollup/plugin-babel @rollup/plugin-terser @babel/core @babel/preset-env npm WARN EBADENGINE Unsupported engine { npm WARN EBADENGINE package: 'rollup@4.21.0', npm WARN EBADENGINE required: { node: '\u003e=18.0.0', npm: '\u003e=8.0.0' }, npm WARN EBADENGINE current: { node: 'v16.17.1', npm: '8.15.0' } npm WARN EBADENGINE } added 63 packages, removed 4 packages, and changed 93 packages in 15s 20 packages are looking for funding run `npm fund` for details 处理方式：\n这个错误是由于你当前使用的 Node.js 版本 (v16.17.1) 和 Rollup 的最新版本 (4.21.0) 之间存在不兼容问题。Rollup 4.21.0 要求 Node.js 版本为 18.0.0 或更高版本，而你目前使用的版本是 16.17.1，因此出现了 EBADENGINE 警告。\n解决方案： 升级 Node.js 版本\n最简单的解决方法是升级你的 Node.js 版本到 18.0.0 或更高。你可以使用 n 或 nvm 来管理和切换 Node.js 版本。\n使用 n 工具升级：\nsudo npm install -g n sudo n stable 使用 nvm 工具升级：\nnvm install 18 nvm use 18 然后再次运行 npm install 来安装依赖。\n使用支持 Node.js 16 的 Rollup 版本\n如果你无法升级 Node.js 版本（比如项目需要兼容 Node.js 16），你可以安装一个旧版本的 Rollup。比如，Rollup 3.x 支持 Node.js 16。\n执行以下命令安装较旧的 Rollup 版本：\nnpm install --save-dev rollup@3 @rollup/plugin-node-resolve @rollup/plugin-commonjs @rollup/plugin-babel @rollup/plugin-terser @babel/core @babel/preset-env 2. @rollup/plugin-commonjs主要处理什么语法？什么情况下，output才需要输出CommonJS？ @rollup/plugin-commonjs插件主要处理CommonJS(CJS)模块的语法，特别在Node.js环境中。它使用require()函数来同步地加载其他模块，并通过 module.exports或exports对象来导出模块的功能。\n示例：\n假设你有一个CommonJS模块（math.js），它定义了一些数学函数并导出它们：\n// math.js (CommonJS) function add(a, b) { return a + b; } function subtract(a, b) { return a - b; } module.exports = { add, subtract }; 然后，你想在另一个使用 ES 模块语法的文件中导入这个 CommonJS 模块。但由于 Rollup 默认只理解 ES 模块，它无法直接解析 require() 调用。这就是 @rollup/plugin-commonjs 插件发挥作用的地方。它可以将 CommonJS 模块转换为 Rollup 可以理解的 ES 模块格式。\n何时需要输出 CommonJS格式（如 .cjs.js），主要有以下几种情况： 背景：在Node.js中，版本12才开始对ES 模块有基础的支持\n兼容性：某些库或应用程序（因为需要支持较旧的Node.js版本或特定环境）不支持ES 模块。 生态系统支持：输出CommonJS 格式可确保你的库或应用程序，被基于CommonJS的工具和构建系统（如：Node.js包管理工具npm）所消费。 性能考虑：在某些情况下，CommonJS 模块比ES 模块加载得更快，因为它们通常使用同步的require()调用。然而，在现代Node.js 版本中通常差异很小，且随着ES 模块性能的提升而逐渐消失。 外部使用场景：外部使用 CommonJS 模块的场景非常广泛，包括但不限于： Node.js 项目：在 Node.js 中，直到版本 12 才开始对 ES 模块有基本的支持，而 CommonJS 仍然是主流。 遗留代码库：许多旧的项目和库仍然使用 CommonJS，因为它们是在 ES 模块成为标准之前就开发的。 混合项目：在一些项目中，你可能需要同时支持 ES 模块和 CommonJS 模块，以便能够兼容不同的环境或工具链。 npm 包：由于 npm 是 JavaScript 社区中最大的包注册表之一，并且许多包仍然使用 CommonJS，因此如果你正在开发一个 npm 包，并希望它能够被尽可能多的项目所使用，那么通常需要支持 CommonJS 格式。 3. 如何保持开发和构建文件目录一致，以便于调试和排查问题？ 示例： 假设你的 src 目录结构如下：\nsrc/ index.js utils/ helper.js components/ button.js modal.js 在打包后，你的 lib 目录结构和src保持一致：\nlib/ index.js utils/ helper.js components/ button.js modal.js 优化 rollup.config.js：\ndir 选项：在 output 配置中使用 dir 而不是 file，Rollup会将输出的文件放在指定的目录中，而不是生成单一的文件 preserveModules：启用此选项，Rollup将保留模块的原始结构，而不是将所有文件打包到一个文件中（每个模块会生成一个独立的文件 preserveModulesRoot：指定保留的模块目录的根目录。此例中，src 目录的层级结构会保持到 lib 中 export default { input: 'src/index.js', // 入口文件（可支持多个入口） output: [ { dir: 'lib', // 输出文件夹 format: 'es', // ES Module 输出 sourcemap: true, preserveModules: true, // 保持模块结构 preserveModulesRoot: 'src', // 保持 src 目录结构 }, ], external: ['@js/base-sdk'], // 忽略package.json中的依赖，避免被打包到libs plugins: [ // ... ], }; 总结 常用（最终）配置 待补充…\n参考 rollup.js 中文文档 最后， 希望大家早日实现：成为编程高手的伟大梦想！ 欢迎交流~\n本文版权归原作者曜灵所有！未经允许，严禁转载！对非法转载者, 原作者保留采用法律手段追究的权利！ 若需转载，请联系微信公众号：连先生有猫病，可获取作者联系方式！\n","wordCount":"2806","inLanguage":"zh","datePublished":"2024-08-27T19:36:15+08:00","dateModified":"2024-08-27T19:36:15+08:00","author":[{"@type":"Person","name":"曜灵"}],"mainEntityOfPage":{"@type":"WebPage","@id":"https://lianpf.github.io/posts/frontend-develop/engine-rollup-config/"},"publisher":{"@type":"Organization","name":"曜灵（SUN）Site","logo":{"@type":"ImageObject","url":"https://lianpf.github.io/img-common/favicon.png"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lianpf.github.io/ accesskey=h title="曜灵（SUN）Site (Alt + H)"><img src=https://lianpf.github.io/img-common/avatar.jpeg alt=logo aria-label=logo height=35>曜灵（SUN）Site</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lianpf.github.io/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li><a href=https://lianpf.github.io/ title="🏠 主页"><span>🏠 主页</span></a></li><li><a href=https://lianpf.github.io/archives/ title="⏱️ 归档"><span>⏱️ 归档</span></a></li><li><a href=https://lianpf.github.io/tags title="🧩 标签"><span>🧩 标签</span></a></li><li><a href=https://lianpf.github.io/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://lianpf.github.io/>🏠 主页</a>&nbsp;»&nbsp;<a href=https://lianpf.github.io/posts/>📚文章</a>&nbsp;»&nbsp;<a href=https://lianpf.github.io/posts/frontend-develop/>👨🏻‍💻 前端</a></div><h1 class=post-title>工程化：Rollup 构建</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2024-08-27
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>2806字
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>6分钟
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>曜灵
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://lianpf.github.io/tags/%E5%B7%A5%E7%A8%8B%E5%8C%96/ style=color:var(--secondary)!important>工程化</a>
&nbsp;<a href=https://lianpf.github.io/tags/rollup/ style=color:var(--secondary)!important>Rollup</a></span></span></span></span>
<span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script>
<script>let url=document.documentURI,dnsUrl="https://lianpf.github.io/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:null,region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%b8%80%e5%ae%89%e8%a3%85%e4%bd%bf%e7%94%a8 aria-label=一、安装使用>一、安装使用</a></li><li><a href=#%e4%ba%8c%e5%9f%ba%e7%a1%80%e7%a4%ba%e4%be%8b aria-label=二、基础示例>二、基础示例</a><ul><li><a href=#1%e5%ae%89%e8%a3%85%e4%be%9d%e8%b5%96%e5%92%8c%e6%96%87%e4%bb%b6%e9%85%8d%e7%bd%ae aria-label=1.安装依赖和文件配置>1.安装依赖和文件配置</a><ul><li><a href=#11-%e5%ae%89%e8%a3%85%e4%be%9d%e8%b5%96 aria-label="1.1 安装依赖">1.1 安装依赖</a></li><li><a href=#12-rollup-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="1.2 Rollup 配置文件">1.2 Rollup 配置文件</a></li><li><a href=#13-babel-%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6 aria-label="1.3 Babel 配置文件">1.3 Babel 配置文件</a></li></ul></li><li><a href=#2%e6%9e%84%e5%bb%ba%e5%91%bd%e4%bb%a4 aria-label=2.构建命令>2.构建命令</a></li></ul></li><li><a href=#%e4%b8%89%e5%b8%b8%e8%a7%81%e9%97%ae%e9%a2%98 aria-label=三、常见问题>三、常见问题</a><ul><li><a href=#1-%e6%83%b3%e8%a6%81%e5%9c%a8node-16%e7%8e%af%e5%a2%83%e4%b8%8b%e4%bd%bf%e7%94%a8rollup%e6%9e%84%e5%bb%ba%e8%af%b7%e9%97%ae%e6%88%91%e8%a6%81%e5%a6%82%e4%bd%95%e5%a4%84%e7%90%86 aria-label="1. 想要在node 16环境下，使用rollup构建，请问我要如何处理？">1. 想要在<code>node 16</code>环境下，使用<code>rollup</code>构建，请问我要如何处理？</a></li><li><a href=#%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88 aria-label=解决方案：>解决方案：</a></li><li><a href=#2-rollupplugin-commonjs%e4%b8%bb%e8%a6%81%e5%a4%84%e7%90%86%e4%bb%80%e4%b9%88%e8%af%ad%e6%b3%95%e4%bb%80%e4%b9%88%e6%83%85%e5%86%b5%e4%b8%8boutput%e6%89%8d%e9%9c%80%e8%a6%81%e8%be%93%e5%87%bacommonjs aria-label="2. @rollup/plugin-commonjs主要处理什么语法？什么情况下，output才需要输出CommonJS？">2. <code>@rollup/plugin-commonjs</code>主要处理什么语法？什么情况下，output才需要输出CommonJS？</a></li><li><a href=#3-%e5%a6%82%e4%bd%95%e4%bf%9d%e6%8c%81%e5%bc%80%e5%8f%91%e5%92%8c%e6%9e%84%e5%bb%ba%e6%96%87%e4%bb%b6%e7%9b%ae%e5%bd%95%e4%b8%80%e8%87%b4%e4%bb%a5%e4%be%bf%e4%ba%8e%e8%b0%83%e8%af%95%e5%92%8c%e6%8e%92%e6%9f%a5%e9%97%ae%e9%a2%98 aria-label="3. 如何保持开发和构建文件目录一致，以便于调试和排查问题？">3. 如何保持开发和构建文件目录一致，以便于调试和排查问题？</a></li></ul></li><li><a href=#%e6%80%bb%e7%bb%93 aria-label=总结>总结</a><ul><li><a href=#%e5%b8%b8%e7%94%a8%e6%9c%80%e7%bb%88%e9%85%8d%e7%bd%ae aria-label=常用（最终）配置>常用（最终）配置</a></li></ul></li><li><a href=#%e5%8f%82%e8%80%83 aria-label=参考>参考</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{elements&&(activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p><code>Rollup</code>是一个用于<code>JavaScript</code>的模块打包工具，使用<code>JavaScript</code>的<code>ES6</code>版本中包含的新标准化代码模块格式，而不是以前的<code>CommonJS</code>和<code>AMD</code>等特殊解决方案。让你像<code>ES 模块</code>一样，在所有场景获得原生支持，自由无缝地组合<strong>你最喜欢的库中最有用的个别函数</strong>&mldr;</p><p>系列文章：</p><ul><li>第一篇：<a href=/posts/frontend-develop/engine-babel-faq/>工程化: babel的一些常见问题</a></li><li>第二篇：<a href=/posts/frontend-develop/engine-rollup-config/>工程化：Rollup 构建</a></li><li>第二篇：<a href=/posts/frontend-develop/engine-webpack-vuecli-config/>工程化：@vue/cli 和 Webpack 构建</a></li></ul><hr><h2 id=一安装使用>一、安装使用<a hidden class=anchor aria-hidden=true href=#一安装使用>#</a></h2><p>作为 <strong><font color=Tomato>全局命令行工具</font></strong> 使用</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install --global rollup
</span></span></code></pre></div><hr><h2 id=二基础示例>二、基础示例<a hidden class=anchor aria-hidden=true href=#二基础示例>#</a></h2><p>场景描述：利用<code>ES MODULE</code>机制，封装了一个<code>@js/sdk</code>包。其中，要求对于<code>?.</code>类似语法，进行<code>ES5</code>的编译处理。<code>@js/sdk</code>具体要求如下:</p><ul><li><code>sdk/src/index.js</code>导出如下：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>modelA</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>modelB</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>} <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;./zmini/index&#39;</span> 
</span></span></code></pre></div><ul><li><code>sdk/src/utils/util.js</code>等使用<code>?.</code>语法文件，进行编译：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>resError</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>platform</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>code</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>code</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>errorCode</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>subCode</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>message</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><ul><li>前期主要利用<code>bable</code>，进行构建，所以需要兼容<code>bable</code>相关逻辑。历史<code>package.json</code>核心如下：</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;scripts&#34;</span>: <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;build&#34;</span>: <span style=color:#e6db74>&#34;babel src -d lib&#34;</span> // 构建命令
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;devDependencies&#34;</span>: <span style=color:#f92672>{</span> 
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;@babel/cli&#34;</span>: <span style=color:#e6db74>&#34;^7.23.4&#34;</span>, // babel 依赖
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;@babel/core&#34;</span>: <span style=color:#e6db74>&#34;^7.23.5&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;@babel/preset-env&#34;</span>: <span style=color:#e6db74>&#34;^7.23.5&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><h3 id=1安装依赖和文件配置>1.安装依赖和文件配置<a hidden class=anchor aria-hidden=true href=#1安装依赖和文件配置>#</a></h3><h4 id=11-安装依赖>1.1 安装依赖<a hidden class=anchor aria-hidden=true href=#11-安装依赖>#</a></h4><p><strong>安装必要的依赖包</strong>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm install --save-dev rollup @rollup/plugin-node-resolve @rollup/plugin-commonjs @rollup/plugin-babel @rollup/plugin-terser @babel/core @babel/preset-env
</span></span></code></pre></div><ul><li><strong><code>@rollup/plugin-node-resolve</code></strong>: 允许 Rollup 查找并打包 <code>node_modules</code> 中的模块。</li><li><strong><code>@rollup/plugin-commonjs</code></strong>: 使 Rollup 可以转换 CommonJS 模块为 ES6 模块。</li><li><strong><code>@rollup/plugin-babel</code></strong>: 集成 Babel 以便处理现代 JavaScript 语法，并将其转换为支持更老的环境（如 Node.js 12+）的代码。</li><li><strong><code>@rollup/plugin-terser</code></strong>: 用于压缩输出的代码，以减小打包后的体积。</li><li><strong><code>babel.config.js</code></strong>: 配置 Babel，使其使用 <code>@babel/preset-env</code> 来根据目标环境编译代码，并使用 <code>core-js</code> 自动引入 polyfill 以支持可选链语法和其他现代 JavaScript 特性。</li></ul><h4 id=12-rollup-配置文件>1.2 Rollup 配置文件<a hidden class=anchor aria-hidden=true href=#12-rollup-配置文件>#</a></h4><p>创建一个 <code>rollup.config.js</code> 文件，内容如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>resolve</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@rollup/plugin-node-resolve&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>commonjs</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@rollup/plugin-commonjs&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> <span style=color:#a6e22e>babel</span> <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@rollup/plugin-babel&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#66d9ef>import</span> { <span style=color:#a6e22e>terser</span> } <span style=color:#a6e22e>from</span> <span style=color:#e6db74>&#39;@rollup/plugin-terser&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>// import terser from &#39;@rollup/plugin-terser&#39;; // 某些版本是默认导出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>input</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;src/index.js&#39;</span>, <span style=color:#75715e>// 入口文件
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>output</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#75715e>//     {
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//         file: &#39;lib/bundle.cjs.js&#39;, // CommonJS 输出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//         format: &#39;cjs&#39;,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//         sourcemap: true,
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>//    },
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>       {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>file</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;lib/bundle.esm.js&#39;</span>, <span style=color:#75715e>// ES Module 输出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;es&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sourcemap</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>       }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>external</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;@js/base-sdk&#39;</span>], <span style=color:#75715e>// 忽略package.json中的依赖，避免被打包到libs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolve</span>(), <span style=color:#75715e>// 解析模块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>commonjs</span>(), <span style=color:#75715e>// 处理 CommonJS 模块
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>babel</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>babelHelpers</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;bundled&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>exclude</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;node_modules/**&#39;</span>, <span style=color:#75715e>// 只编译我们的源码
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>            <span style=color:#a6e22e>presets</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>                [
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;@babel/preset-env&#39;</span>,
</span></span><span style=display:flex><span>                    {
</span></span><span style=display:flex><span>                       <span style=color:#a6e22e>targets</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>                         <span style=color:#a6e22e>node</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;12&#39;</span>, <span style=color:#75715e>// 确保支持 node 12+
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                       },
</span></span><span style=display:flex><span>                       <span style=color:#a6e22e>useBuiltIns</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;usage&#39;</span>,
</span></span><span style=display:flex><span>                       <span style=color:#a6e22e>corejs</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span>, <span style=color:#75715e>// 自动引入 polyfill
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>                    },
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>            ],
</span></span><span style=display:flex><span>       }),
</span></span><span style=display:flex><span>       <span style=color:#a6e22e>terser</span>() <span style=color:#75715e>// 代码压缩
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ],
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><h4 id=13-babel-配置文件>1.3 Babel 配置文件<a hidden class=anchor aria-hidden=true href=#13-babel-配置文件>#</a></h4><p>创建一个 <code>.babelrc</code> 或 <code>babel.config.js</code> 文件配置Babel，确保编译目标支持较老的 Node.js 环境：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;presets&#34;</span>: [
</span></span><span style=display:flex><span>        [
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;@babel/preset-env&#34;</span>,
</span></span><span style=display:flex><span>            {
</span></span><span style=display:flex><span>               <span style=color:#f92672>&#34;targets&#34;</span>: {
</span></span><span style=display:flex><span>                 <span style=color:#f92672>&#34;node&#34;</span>: <span style=color:#e6db74>&#34;12&#34;</span>
</span></span><span style=display:flex><span>               },
</span></span><span style=display:flex><span>               <span style=color:#f92672>&#34;useBuiltIns&#34;</span>: <span style=color:#e6db74>&#34;usage&#34;</span>,
</span></span><span style=display:flex><span>               <span style=color:#f92672>&#34;corejs&#34;</span>: <span style=color:#ae81ff>3</span>
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        ]
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=2构建命令>2.构建命令<a hidden class=anchor aria-hidden=true href=#2构建命令>#</a></h3><p>在你的 <code>sdk/package.json</code> 中，更新 <code>scripts</code> 部分，使用 Rollup 构建你的包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;module&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 第一种方式：使用 main 和 module 两个配置
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// &#34;main&#34;: &#34;./lib/bundle.cjs.js&#34;,  // CommonJS 入口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// &#34;module&#34;: &#34;./lib/bundle.esm.js&#34;, // ES Module 入口
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#75715e>// 第二种：只使用main —— 推荐这种
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;main&#34;</span>: <span style=color:#e6db74>&#34;./lib/bundle.esm.js&#34;</span>,  <span style=color:#75715e>// 入口配置ES Module
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#f92672>&#34;scripts&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#f92672>&#34;build&#34;</span>: <span style=color:#e6db74>&#34;rollup -c&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>终端运行以下命令来构建你的 SDK 包：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ npm run build
</span></span></code></pre></div><p>构建完成后，生成的文件将在 <code>lib/</code> 目录下，分别以 CommonJS 和 ES Module 格式输出。这些文件将兼容 Node.js 12 及更高版本。</p><hr><h2 id=三常见问题>三、常见问题<a hidden class=anchor aria-hidden=true href=#三常见问题>#</a></h2><h3 id=1-想要在node-16环境下使用rollup构建请问我要如何处理>1. 想要在<code>node 16</code>环境下，使用<code>rollup</code>构建，请问我要如何处理？<a hidden class=anchor aria-hidden=true href=#1-想要在node-16环境下使用rollup构建请问我要如何处理>#</a></h3><p>异常如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lianpf@lianpf-PC:~/xxx/@js/sdk$ npm install --save-dev rollup @rollup/plugin-node-resolve @rollup/plugin-commonjs @rollup/plugin-babel @rollup/plugin-terser @babel/core @babel/preset-env
</span></span><span style=display:flex><span>npm WARN EBADENGINE Unsupported engine <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>npm WARN EBADENGINE   package: <span style=color:#e6db74>&#39;rollup@4.21.0&#39;</span>,
</span></span><span style=display:flex><span>npm WARN EBADENGINE   required: <span style=color:#f92672>{</span> node: <span style=color:#e6db74>&#39;&gt;=18.0.0&#39;</span>, npm: <span style=color:#e6db74>&#39;&gt;=8.0.0&#39;</span> <span style=color:#f92672>}</span>,
</span></span><span style=display:flex><span>npm WARN EBADENGINE   current: <span style=color:#f92672>{</span> node: <span style=color:#e6db74>&#39;v16.17.1&#39;</span>, npm: <span style=color:#e6db74>&#39;8.15.0&#39;</span> <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>npm WARN EBADENGINE <span style=color:#f92672>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>added <span style=color:#ae81ff>63</span> packages, removed <span style=color:#ae81ff>4</span> packages, and changed <span style=color:#ae81ff>93</span> packages in 15s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>20</span> packages are looking <span style=color:#66d9ef>for</span> funding
</span></span><span style=display:flex><span>  run <span style=color:#e6db74>`</span>npm fund<span style=color:#e6db74>`</span> <span style=color:#66d9ef>for</span> details
</span></span></code></pre></div><p>处理方式：</p><p>这个错误是由于你当前使用的 Node.js 版本 (v16.17.1) 和 Rollup 的最新版本 (4.21.0) 之间存在不兼容问题。Rollup 4.21.0 要求 Node.js 版本为 18.0.0 或更高版本，而你目前使用的版本是 16.17.1，因此出现了 <code>EBADENGINE</code> 警告。</p><h3 id=解决方案>解决方案：<a hidden class=anchor aria-hidden=true href=#解决方案>#</a></h3><ol><li><p><strong>升级 Node.js 版本</strong><br>最简单的解决方法是升级你的 Node.js 版本到 18.0.0 或更高。你可以使用 <a href=https://github.com/tj/n>n</a> 或 <a href=https://github.com/nvm-sh/nvm>nvm</a> 来管理和切换 Node.js 版本。</p><ul><li><p>使用 <code>n</code> 工具升级：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo npm install -g n
</span></span><span style=display:flex><span>sudo n stable
</span></span></code></pre></div></li><li><p>使用 <code>nvm</code> 工具升级：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>nvm install <span style=color:#ae81ff>18</span>
</span></span><span style=display:flex><span>nvm use <span style=color:#ae81ff>18</span>
</span></span></code></pre></div></li></ul><p>然后再次运行 <code>npm install</code> 来安装依赖。</p></li><li><p><strong>使用支持 Node.js 16 的 Rollup 版本</strong><br>如果你无法升级 Node.js 版本（比如项目需要兼容 Node.js 16），你可以安装一个旧版本的 Rollup。比如，Rollup 3.x 支持 Node.js 16。</p><p>执行以下命令安装较旧的 Rollup 版本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>npm install --save-dev rollup@3 @rollup/plugin-node-resolve @rollup/plugin-commonjs @rollup/plugin-babel @rollup/plugin-terser @babel/core @babel/preset-env
</span></span></code></pre></div></li></ol><h3 id=2-rollupplugin-commonjs主要处理什么语法什么情况下output才需要输出commonjs>2. <code>@rollup/plugin-commonjs</code>主要处理什么语法？什么情况下，output才需要输出CommonJS？<a hidden class=anchor aria-hidden=true href=#2-rollupplugin-commonjs主要处理什么语法什么情况下output才需要输出commonjs>#</a></h3><p><code>@rollup/plugin-commonjs</code>插件主要处理<code>CommonJS(CJS)</code>模块的语法，特别在<code>Node.js</code>环境中。它使用<code>require()</code>函数来同步地加载其他模块，并通过 <code>module.exports</code>或<code>exports</code>对象来导出模块的功能。</p><p>示例：<br>假设你有一个<code>CommonJS</code>模块（math.js），它定义了一些数学函数并导出它们：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// math.js (CommonJS)  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>add</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>) {  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>b</span>;  
</span></span><span style=display:flex><span>}  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>subtract</span>(<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>) {  
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>b</span>;  
</span></span><span style=display:flex><span>}  
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#a6e22e>module</span>.<span style=color:#a6e22e>exports</span> <span style=color:#f92672>=</span> { <span style=color:#a6e22e>add</span>, <span style=color:#a6e22e>subtract</span> };
</span></span></code></pre></div><p>然后，你想在另一个使用 ES 模块语法的文件中导入这个 CommonJS 模块。但由于 Rollup 默认只理解 ES 模块，它无法直接解析 require() 调用。这就是 @rollup/plugin-commonjs 插件发挥作用的地方。它可以将 CommonJS 模块转换为 Rollup 可以理解的 ES 模块格式。</p><p><strong>何时需要输出 <code>CommonJS格式</code>（如 <code>.cjs.js</code>）</strong>，主要有以下几种情况：<br></p><blockquote><p>背景：在<code>Node.js</code>中，版本<code>12</code>才开始对<code>ES 模块</code>有基础的支持</p></blockquote><ul><li>兼容性：某些库或应用程序（因为需要支持较旧的<code>Node.js版本</code>或特定环境）不支持<code>ES 模块</code>。</li><li>生态系统支持：输出<code>CommonJS 格式</code>可确保你的库或应用程序，被基于<code>CommonJS</code>的工具和构建系统（如：<code>Node.js</code>包管理工具<code>npm</code>）所消费。</li><li>性能考虑：在某些情况下，<code>CommonJS 模块</code>比<code>ES 模块</code>加载得更快，因为它们通常使用同步的<code>require()</code>调用。然而，在现代<code>Node.js 版本</code>中通常差异很小，且随着<code>ES 模块</code>性能的提升而逐渐消失。</li><li>外部使用场景：外部使用 CommonJS 模块的场景非常广泛，包括但不限于：<ul><li>Node.js 项目：在 Node.js 中，直到版本 12 才开始对 ES 模块有基本的支持，而 CommonJS 仍然是主流。</li><li>遗留代码库：许多旧的项目和库仍然使用 CommonJS，因为它们是在 ES 模块成为标准之前就开发的。</li><li>混合项目：在一些项目中，你可能需要同时支持 ES 模块和 CommonJS 模块，以便能够兼容不同的环境或工具链。</li><li>npm 包：由于 npm 是 JavaScript 社区中最大的包注册表之一，并且许多包仍然使用 CommonJS，因此如果你正在开发一个 npm 包，并希望它能够被尽可能多的项目所使用，那么通常需要支持 CommonJS 格式。</li></ul></li></ul><h3 id=3-如何保持开发和构建文件目录一致以便于调试和排查问题>3. 如何保持开发和构建文件目录一致，以便于调试和排查问题？<a hidden class=anchor aria-hidden=true href=#3-如何保持开发和构建文件目录一致以便于调试和排查问题>#</a></h3><p>示例：<br>假设你的 <code>src</code> 目录结构如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>src/
</span></span><span style=display:flex><span>  index.js
</span></span><span style=display:flex><span>  utils/
</span></span><span style=display:flex><span>    helper.js
</span></span><span style=display:flex><span>  components/
</span></span><span style=display:flex><span>    button.js
</span></span><span style=display:flex><span>    modal.js
</span></span></code></pre></div><p>在打包后，你的 <code>lib</code> 目录结构和<code>src</code>保持一致：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lib/
</span></span><span style=display:flex><span>  index.js
</span></span><span style=display:flex><span>  utils/
</span></span><span style=display:flex><span>    helper.js
</span></span><span style=display:flex><span>  components/
</span></span><span style=display:flex><span>    button.js
</span></span><span style=display:flex><span>    modal.js
</span></span></code></pre></div><p>优化 <code>rollup.config.js</code>：</p><ul><li><code>dir</code> 选项：在 <code>output</code> 配置中使用 <code>dir</code> 而不是 <code>file</code>，<code>Rollup</code>会将输出的文件放在指定的目录中，而不是生成单一的文件</li><li><code>preserveModules</code>：启用此选项，<code>Rollup</code>将保留模块的原始结构，而不是将所有文件打包到一个文件中（每个模块会生成一个独立的文件</li><li><code>preserveModulesRoot</code>：指定保留的模块目录的根目录。此例中，<code>src</code> 目录的层级结构会保持到 <code>lib</code> 中</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>export</span> <span style=color:#66d9ef>default</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>input</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;src/index.js&#39;</span>, <span style=color:#75715e>// 入口文件（可支持多个入口）
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>output</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>dir</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;lib&#39;</span>, <span style=color:#75715e>// 输出文件夹
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;es&#39;</span>, <span style=color:#75715e>// ES Module 输出
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>sourcemap</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>preserveModules</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#75715e>// 保持模块结构
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#a6e22e>preserveModulesRoot</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;src&#39;</span>, <span style=color:#75715e>// 保持 src 目录结构
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    },
</span></span><span style=display:flex><span>  ],
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>external</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;@js/base-sdk&#39;</span>], <span style=color:#75715e>// 忽略package.json中的依赖，避免被打包到libs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#a6e22e>plugins</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ...
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  ],
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><hr><h2 id=总结>总结<a hidden class=anchor aria-hidden=true href=#总结>#</a></h2><h3 id=常用最终配置>常用（最终）配置<a hidden class=anchor aria-hidden=true href=#常用最终配置>#</a></h3><p>待补充&mldr;</p><hr><h2 id=参考>参考<a hidden class=anchor aria-hidden=true href=#参考>#</a></h2><ul><li><a href=https://www.rollupjs.com/>rollup.js 中文文档</a></li></ul><hr><p><strong>最后， 希望大家早日实现：成为编程高手的伟大梦想！</strong><br><strong>欢迎交流~</strong></p><img src=/img-common/weChatPublic.jpg alt=微信公众号 width=600 height=286><p><strong>本文版权归原作者曜灵所有！未经允许，严禁转载！对非法转载者, 原作者保留采用法律手段追究的权利！</strong><br><strong>若需转载，请联系微信公众号：连先生有猫病，可获取作者联系方式！</strong></p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://lianpf.github.io/posts/frontend-develop/engine-webpack-vuecli-config/><span class=title>« 上一页</span><br><span>工程化：@vue/cli 和 Webpack 构建</span></a>
<a class=next href=https://lianpf.github.io/posts/other/pregnancylatecare-and-hospitalnotice/><span class=title>下一页 »</span><br><span>孕晚期保健和入院须知</span></a></nav></footer></div><script src=https://utteranc.es/client.js repo=lianpf/lianpf.github.io issue-term=title label=comments theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>Copyright
&copy;
2016-2024
<a href=https://lianpf.github.io/ style=color:#939393>曜灵（SUN）Site</a>.
基于 Hugo 引擎和 PaperMod 主题</span>
<a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString()+`

————————————————
版权声明：本文为「曜灵（SUN）Site」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href,s=window.getSelection().toString()+`

————————————————
版权声明：本文为「曜灵（SUN）Site」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href;t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function i(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent+`
————————————————
版权声明：本文为「曜灵（SUN）Site」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>