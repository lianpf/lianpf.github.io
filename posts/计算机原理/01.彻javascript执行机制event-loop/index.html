<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><title>彻底弄懂JavaScript执行机制（Event Loop） | 曜灵（SUN）Site</title><link href=/img-common/favicon.png rel="shortcut icon" type=image/x-icon><meta name=author content="曜灵"><meta name=description content="背景 作为一枚“前端打字员”， 无论是新手还是老鸟，都会遇到一个"><meta name=generator content="Hugo 0.74.2"><link rel=canonical href=/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/01.%E5%BD%BBjavascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6event-loop/><meta property="og:title" content="彻底弄懂JavaScript执行机制（Event Loop）"><meta property="og:description" content="背景 作为一枚“前端打字员”， 无论是新手还是老鸟，都会遇到一个"><meta property="og:type" content="article"><meta property="og:url" content="/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/01.%E5%BD%BBjavascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6event-loop/"><meta property="article:published_time" content="2020-01-18T00:00:00+00:00"><meta property="article:modified_time" content="2020-01-18T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="彻底弄懂JavaScript执行机制（Event Loop）"><meta name=twitter:description content="背景 作为一枚“前端打字员”， 无论是新手还是老鸟，都会遇到一个"><link rel=stylesheet href=/css/semantic.min.css><link rel=stylesheet href=/css/OverlayScrollbars.min.css><link rel=stylesheet href=/css/github-markdown.css><link rel=stylesheet href=/css/site.css><style>.inverted a{color:#8fbc8f!important}</style><style>body{background-image:url(/img-common/background.jpg)}</style><link rel=stylesheet data-highlight href=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/gruvbox-light.min.css></head><body><nav class="ui secondary inverted menu dream-menu"><div class=item><i class="large link bullseye icon dream-flip-toggle" title=翻转！></i></div><div class=item><i class="large link home icon" title=首页 onclick="window.location.href='\/'"></i></div><div class=item><i class="large link icon theme-switch" onclick=themeSwitch()></i></div><div class=item><i class="large link search icon" onclick=toggleSearch()></i></div></nav><div class=flip-container><div class=flipper><section class=front><div class=dream-max-width><div class="ui centered relaxed grid dream-grid"><div class="sixteen wide mobile sixteen wide tablet twelve wide computer column markdown-body dream-single" id=dream-save-post-as-img><section class="ui top attached segment cover"><div class=cover-img style=background-image:url()></div></section><section class="ui attached segment"><header><h1 class="ui large header">彻底弄懂JavaScript执行机制（Event Loop）<div class="sub header">@
曜灵
· Saturday, Jan 18, 2020
· 3 分钟阅读
· 更新于 Jan 18, 2020</div></h1></header><article style=margin-top:2rem><h3 id=背景>背景</h3><blockquote><p>作为一枚“前端打字员”， 无论是新手还是老鸟，都会遇到一个令人深省的问题，既然js 是单线程执行的，是按照语句出现的顺序执行的，那么异步的代码 js 是怎么处理的呢？下面的代码是如何进行输出的？</p></blockquote><pre><code>console.log(1);
setTimeout(function() {
    console.log(2);
}, 0);
new Promise(function(resolve) {
    console.log(3);
    resolve(Date.now());
}).then(function() {
    console.log(4);
});
console.log(5);
setTimeout(function() {
    new Promise(function(resolve) {
        console.log(6);
        resolve(Date.now());
    }).then(function() {
        console.log(7);
    });
}, 0);
</code></pre><p>好了，小伙子们可以尽情发挥你的想象力，如果你的答案不是”1, 3, 5, 4, 2, 6, 7“，那你就要认认真真接着往下看了。什么？你竟然答对了。那你更要接着往下看，后面还有好看的彩蛋哦~</p><hr><h3 id=同步和异步>同步和异步</h3><blockquote><p>首先通过一张导图来看一下javascript事件循环中，同步和异步的关系：</p></blockquote><p></p><ul><li>同步和异步任务分别进入不同的执行 process，同步的进入主线程，异步的进入Event Table并注册函数。</li><li>当指定的事情完成时，Event Table会将这个函数移入Event Queue。</li><li>主线程内的任务执行完毕为空，会去Event Queue读取对应的函数，进入主线程执行。</li><li>上述过程会不断重复，也就是常说的Event Loop(事件循环)</li></ul><p>那么还有一个问题：<br>那怎么知道主线程执行栈为空啊？js引擎存在monitoring process进程，会持续不断的检查主线程执行栈是否为空，一旦为空，就会去Event Queue那里检查是否有等待被调用的函数</p><hr><h3 id=宏任务和微任务时间循环>宏任务和微任务、时间循环</h3><p>然而，仅仅理解到此，当然是还不够的：
除了广义的同步任务和异步任务，我们对任务有更精细的定义：</p><ul><li>macro-task(宏任务)：包括整体代码script，setTimeout，setInterval</li><li>micro-task(微任务)：Promise，process.nextTick</li></ul><p>事件循环，宏任务，微任务的关系如图所示：</p><p><img src=/img-blogs/20200118-002.png alt=宏任务和微任务></p><blockquote><p>事件循环的顺序，决定js代码的执行顺序。进入整体代码(宏任务)后，开始第一次循环。接着执行所有的微任务。然后再次从宏任务开始，找到其中一个任务队列执行完毕，再执行所有的微任务</p></blockquote><p>回到我们上面说的实例代码:</p><pre><code>console.log(1);
setTimeout(function() {
    console.log(2);
}, 0);
new Promise(function(resolve) {
    console.log(3);
    resolve(Date.now());
}).then(function() {
    console.log(4);
});
console.log(5);
setTimeout(function() {
    new Promise(function(resolve) {
        console.log(6);
        resolve(Date.now());
    }).then(function() {
        console.log(7);
    });
}, 0);
</code></pre><p>执行步骤如下：</p><ol><li>执行 log(1)，输出 1；</li><li>遇到 setTimeout，将回调的代码 log(2)添加到宏任务中等待执行；</li><li>执行 console.log(3)，将 then 中的 log(4)添加到微任务中；</li><li>执行 log(5)，输出 5；</li><li>遇到 setTimeout，将回调的代码 log(6, 7)添加到宏任务中；</li><li>宏任务的一个任务执行完毕，查看微任务队列中是否存在任务，存在一个微任务 log(4)（在步骤 3 中添加的），执行输出 4；</li><li>取出下一个宏任务 log(2)执行，输出 2；</li><li>宏任务的一个任务执行完毕，查看微任务队列中是否存在任务，不存在；</li><li>取出下一个宏任务执行，执行 log(6)，将 then 中的 log(7)添加到微任务中；</li><li>宏任务执行完毕，存在一个微任务 log(7)（在步骤 9 中添加的），执行输出 7；</li></ol><p>因此，最终的输出顺序为：1, 3, 5, 4, 2, 6, 7;</p><blockquote><p>当然，你可以在Promise.then实现一个稍微耗时的操作(比如 1~1000的for循环)，这个步骤看起来会更加地明显。马上会输出1，稍等一会儿才会输出3，然后再输出2。不论等待多长时间输出3，2一定会在3的后面输出。这也就印证了eventloop中的第3步操作，必须等所有的微任务执行完毕后，才开始下一个宏任务</p></blockquote><hr><h3 id=常见的宏任务微任务>常见的宏任务、微任务</h3><h4 id=宏任务>宏任务</h4><ul><li>setTimeout、setInterval</li><li>setImmediate(node.js)</li><li>渲染任务、JS脚本执行</li><li>IO操作（网络请求、文件读写）</li></ul><h4 id=微任务>微任务</h4><ul><li>Promise.resolve()</li><li>MutationObserver(web)</li><li>process.nextTick(node.js)</li></ul><h4 id=requestanimationframeweb>requestAnimationFrame(web)</h4><blockquote><p>也属于异步执行的方法，但该方法既不属于宏任务，也不属于微任务, 具体参考<a href=https://developer.mozilla.org/zh-CN/docs/Web/API/Window/requestAnimationFrame>MDN</a>中的定义</p></blockquote><hr><h3 id=总结>总结</h3><ul><li>javascript是一门单线程语言</li><li>Event Loop是 javascript的执行机制</li></ul><hr><p><strong>最后， 希望大家早日实现：成为前端高手的伟大梦想！</strong>
<strong>欢迎交流~</strong></p><p></p></article></section><footer class="ui attached segment dream-tags" data-html2canvas-ignore><a class="ui label" href=/tags/javascript title=JavaScript>JavaScript</a>
<a class="ui label" href=/tags/%E6%B5%8F%E8%A7%88%E5%99%A8 title=浏览器>浏览器</a><div class="ui label" style=float:right;cursor:pointer onclick=savePostAsImg()><i class="save icon"></i>保存为图片</div></footer><footer class="ui bottom attached stacked segment post-disqus-area" data-html2canvas-ignore><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url='\/posts\/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86\/01.%E5%BD%BBjavascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6event-loop\/';this.page.identifier='\/posts\/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86\/01.%E5%BD%BBjavascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6event-loop\/';};(function(){var d=document,s=d.createElement('script');s.src='https://'+'...'+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></footer><div class="ui segment utterances-comments" data-html2canvas-ignore><script src=https://utteranc.es/client.js repo=lianpf/lianpf.github.io issue-term=og:title theme=github-light crossorigin=anonymous async></script></div></div><div class="sixteen wide mobile sixteen wide tablet four wide computer column"><article class=dream-header><section class="ui top attached center aligned segment"><div class="ui small circular image"><img src=/img-common/favicon.png></div><div class="ui medium header">曜灵 的博客<div class="sub header" style=margin-top:.5rem>带着 "偏见" 去理解技术的世界！</div></div><div class="ui horizontal list"><a class=item href=/posts><i class="archive icon" title=归档></i></a><a class=item href=/tags><i class="tags icon" title=所有标签></i></a><a class=item href=/categories><i class="th list icon" title=所有分类></i></a></div></section><section class="ui attached center aligned segment dream-tags"><a class="ui label" href=/tags/github-action title=github-action>github-action</a>
<a class="ui label" href=/tags/hugo title=hugo>hugo</a>
<a class="ui label" href=/tags/javascript title=javascript>javascript</a>
<a class="ui label" href=/tags/react%E6%8A%80%E6%9C%AF%E6%A0%88 title=react技术栈>react技术栈</a>
<a class="ui label" href=/tags/vue%E6%8A%80%E6%9C%AF%E6%A0%88 title=vue技术栈>vue技术栈</a>
<a class="ui label" href=/tags/%E6%B5%8F%E8%A7%88%E5%99%A8 title=浏览器>浏览器</a>
<a class="ui label" href=/tags/%E7%AE%97%E6%B3%95 title=算法>算法</a>
<a class="ui label" href=/tags/%E8%87%AA%E5%8A%A8%E5%8C%96 title=自动化>自动化</a>
<a class="ui label" href=/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F title=设计模式>设计模式</a></section><section class="ui attached segment dream-categories"><div class="ui accordion"><div class=title><i class="dropdown icon"></i><a href=/categories/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80 class=item>前端基础</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/posts/%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80/01.%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84this/ class=item>JavaScript之你不知道的this</a></div></div></div></div><div class=title><i class="dropdown icon"></i><a href=/categories/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6 class=item>前端框架</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/posts/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/02.%E5%AF%B9%E6%AF%94-react-hooks-%E5%92%8C-vue-composition-api/ class=item>对比 React Hooks 和 Vue Composition API</a></div></div><div class=item><div class=content><a href=/posts/%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6/01.diff%E7%AE%97%E6%B3%95/ class=item>聊一聊Diff算法（React、Vue）</a></div></div></div></div><div class=title><i class="dropdown icon"></i><a href=/categories/%E5%BC%80%E5%8F%91%E6%97%A5%E8%AE%B0 class=item>开发日记</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/posts/%E5%BC%80%E5%8F%91%E6%97%A5%E8%AE%B0/01.%E8%87%AA%E5%8A%A8%E5%8C%96%E6%9E%84%E5%BB%BA%E5%8D%9A%E5%AE%A2/ class=item>GitHub Action + Hugo 自动构建发布个人博客</a></div></div></div></div><div class=title><i class="dropdown icon"></i><a href=/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86 class=item>计算机原理</a></div><div class=content><div class="ui list"><div class=item><div class=content><a href=/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/01.%E5%BD%BBjavascript%E6%89%A7%E8%A1%8C%E6%9C%BA%E5%88%B6event-loop/ class=item>彻底弄懂JavaScript执行机制（Event Loop）</a></div></div><div class=item><div class=content><a href=/posts/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%8E%9F%E7%90%86/02.javascript%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B8%80/ class=item>聊一聊JavaScript设计模式（一）</a></div></div></div></div></div></section><section class="ui attached segment header-socials"><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=mailto:wanderlian@foxmail.com><i class="mail icon" title=Email></i></a></div><div class=item><a href=https://github.com/lianpf target=_blank><i class="github icon" title=GitHub></i></a></div></nav></section><section class="ui bottom attached center aligned segment"><p>© 2016 - 2020 曜灵（SUN）Site</p><p>Powered by <a href=https://gohugo.io/ target=_blank>Hugo</a> with theme <a href=https://github.com/g1eny0ung/hugo-theme-dream target=_blank>Dream</a>.</p></section></article></div></div></div></section><section class=back><div class=dream-max-width><div class="ui centered relaxed grid dream-grid dream-back"><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article><div class="ui top attached segment"><h3 class="ui header">关于我</h3></div><div class="ui bottom attached segment markdown-body"><p>大家好，欢迎来到“曜灵”的个人博客。</p><p>博主是中通快递集团上海总部，平台工具组的一名软件</p><p>开发工程师。涉及前端 React技术栈、Vue技术栈、设计模式、算法，webpack、node自动构建打包工程化等，以及node相关的领域。
工作之余，也期望投入一些公关的领域为社区做一些自己的贡献，现有两个独立的开源项目</p><ul><li>react PC 组件库<a href=https://www.npmjs.com/package/react-pc-ui>react-pc-ui</a></li><li>脚手架：选择 template 快速搭建 webpack + react + vue项目 <a href=https://www.npmjs.com/package/@lianpf/create-app-cli>@lianpf/create-app-cli</a></li></ul><p>希望和大家一起成长，以下是我个人的社交类账号：</p><ul><li><a href=https://github.com/lianpf>gitHub</a></li><li>微信公众号：连先生有猫病</li><li>掘金：曜灵</li></ul><p>欢迎大家关注我的微信公众号，有好的文章可以关注公众号，获取博主个人微信投稿。文章内容不局限于技术！</p></div></article></section><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"><article><div class="ui top attached segment"><h3 class="ui header">社交链接</h3></div><div class="ui bottom attached segment"><nav class="ui secondary menu dream-menu dream-socials"><div class=item><a href=mailto:wanderlian@foxmail.com><i class="large mail icon" title=Email></i></a></div><div class=item><a href=https://github.com/lianpf target=_blank><i class="large github icon" title=GitHub></i></a></div></nav></div></article></section><section class="sixteen wide mobile eight wide tablet four wide computer column dream-column"></section></div></div></section></div></div><script>window.darkNav=true</script><script src=/js/jquery.min.js></script><script src=/js/semantic.min.js></script><script src=/js/jquery.overlayScrollbars.min.js></script><script src=/js/header.js></script><script src=/js/main.js></script><script src=/js/theme.js></script><script src=/js/html2canvas.min.js></script><script src=/js/post.js></script><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js></script><script src=https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/languages/ocaml.min.js></script><script>hljs.initHighlightingOnLoad()
setHighlightTheme()
function setHighlightTheme(){var isDark=localStore.getItem('hugo-theme-dream-is-dark')
var lightTheme="gruvbox-light"
var darkTheme="gruvbox-dark"
var theme=isDark?darkTheme:lightTheme
$('link[data-highlight]').attr('href','https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/styles/'+theme+'.min.css')
$('pre').css('background',isDark?'#333':'')}</script><div class="ui inverted segment" id=dream-search><div class="ui search"><div class="ui transparent input"><input class=prompt type=text placeholder=搜索></div><div class=results></div></div></div><script>$(document).ready(function(){$.getJSON('\//index.json',function(data){$('.ui.search').search({source:data,searchFields:['title'],showNoResults:true,})})})</script><script src=/js/search.js></script></body></html>