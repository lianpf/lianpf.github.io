<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Node: Apr框架开发 | 曜灵（SUN）Site</title><meta name=keywords content="Node,npm"><meta name=description content="在低代码平台开发过程，由于物料管理系统以及Node Server 中间层的搭建使用过程中，发现很多通用的库和配置可以&mldr;"><meta name=author content="曜灵"><link rel=canonical href=https://lianpf.github.io/posts/backend-develop/11.apr-framework-develop/><link crossorigin=anonymous href=/assets/css/stylesheet.css rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.js onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://lianpf.github.io/img-common/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://lianpf.github.io/img-common/favicon.png><link rel=icon type=image/png sizes=32x32 href=https://lianpf.github.io/img-common/favicon.png><link rel=apple-touch-icon href=https://lianpf.github.io/img-common/avatar.jpeg><link rel=mask-icon href=https://lianpf.github.io/img-common/avatar.jpeg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script>
<script src=https://cdn.jsdelivr.net/npm/jquery@3.6.3/dist/jquery.min.js></script>
<script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script><meta property="og:title" content="Node: Apr框架开发"><meta property="og:description" content="在低代码平台开发过程，由于物料管理系统以及Node Server 中间层的搭建使用过程中，发现很多通用的库和配置可以&mldr;"><meta property="og:type" content="article"><meta property="og:url" content="https://lianpf.github.io/posts/backend-develop/11.apr-framework-develop/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-04-12T17:37:09+08:00"><meta property="article:modified_time" content="2021-04-12T17:37:09+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Node: Apr框架开发"><meta name=twitter:description content="在低代码平台开发过程，由于物料管理系统以及Node Server 中间层的搭建使用过程中，发现很多通用的库和配置可以&mldr;"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"📚文章","item":"https://lianpf.github.io/posts/"},{"@type":"ListItem","position":2,"name":"🧱 后端开发","item":"https://lianpf.github.io/posts/backend-develop/"},{"@type":"ListItem","position":3,"name":"Node: Apr框架开发","item":"https://lianpf.github.io/posts/backend-develop/11.apr-framework-develop/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Node: Apr框架开发","name":"Node: Apr框架开发","description":"在低代码平台开发过程，由于物料管理系统以及Node Server 中间层的搭建使用过程中，发现很多通用的库和配置可以\u0026hellip;\n","keywords":["Node","npm"],"articleBody":"在低代码平台开发过程，由于物料管理系统以及Node Server 中间层的搭建使用过程中，发现很多通用的库和配置可以…\n一、背景 在低代码平台开发过程，由于物料管理系统以及Node Server 中间层的搭建使用过程中，发现很多通用的库和配置可以沉淀，形成可复制的解决方案。所以，基于开源框架Egg.js（基于Koa2）进行了拓展封装形成了初版Apr。\n整个团队依赖初版Apr作为统一的Node方案，随着业务场景越来越丰富，一些插件、middle等公共配置成为最佳实践后，逐渐下沉到Apr框架中，让Apr越来越成熟。而后，依赖Apr的其他项目仅需简单的升级下框架的版本即可享受到Apr带来的红利。\n如果你的团队也在考虑搭建类似的框架，那么请考虑如下问题：\n如果你的团队遇到过： 维护很多个项目，每个项目都需要复制拷贝诸如 gulpfile.js / webpack.config.js 之类的文件 每个项目都需要使用一些相同的类库，相同的配置 在新项目中对上面的配置做了一个优化后，如何同步到其他项目？ 如果你的团队需要： 统一的技术选型，比如数据库、模板、前端框架及各种中间件设施都需要选型，而框架封装后保证应用使用一套架构 统一的默认配置，开源社区的配置可能不适用于公司，而又不希望应用去配置 统一的部署方案，通过框架和平台的双向控制，应用只需要关注自己的代码，具体查看应用部署 统一的代码风格，框架不仅仅解决代码重用问题，还可以对应用做一定约束，作为企业框架是很必要的。Apr依赖于 Egg, Egg 在 Koa 基础上做了很多约定，框架可以使用 Loader 自己定义代码规则 如果需要，以下是Apr的简易版搭建过程，也许对你有所帮助:\n稳定成熟版涉及到公司相关业务，故仅存内网中，不对外暴露，请勿私聊获取\n二、框架与多进程 框架的扩展是和多进程模型有关的，我们已经知道多进程模型，我们需要扩展的类有 Agent 和 Application。\n在 Agent Worker 启动的时候会实例化 Agent，而在 App Worker 启动时会实例化 Application，这两个类又同时继承 EggCore。\nEggCore 可以看做 Koa Application 的升级版，默认内置 Loader、Router 及应用异步启动等功能，可以看做是支持 Loader 的 Koa。 而我们要搭建的Apr则依赖于EggCore。\nKoa Application ^ EggCore ^ AprCore ^ ┌──────┴───────┐ │ │ Apr Agent Apr Application ^ ^ agent worker app worker 三、定制框架: Apr 1. create Apr \u0026 init $ mkdir apr \u0026\u0026 cd apr $ npm init egg --type=framework $ npm i $ npm test 2. 框架继承 框架支持继承关系，可以把框架比作一个类，基类是 Egg 框架，定义一个框架需要继承于Egg且实现 Egg 所有的 API。\n// package.json { \"name\": \"apr\", \"dependencies\": { \"egg\": \"^2.0.0\" } } // index.js module.exports = require('./lib/framework.js'); // lib/framework.js const path = require('path'); const egg = require('egg'); const EGG_PATH = Symbol.for('egg#eggPath'); class Application extends egg.Application { get [EGG_PATH]() { // 返回 framework 路径 return path.dirname(__dirname); } } // 覆盖了 Egg 的 Application module.exports = Object.assign(egg, { Application, }); 应用启动时需要指定框架名（在 package.json 指定 egg.framework，默认为 egg），Loader 将从 node_modules 找指定模块作为框架，并加载其 export 的 Application\n{ \"scripts\": { \"dev\": \"egg-bin dev\" }, \"egg\": { \"framework\": \"apr\" } } 现在 apr 框架目录已经是一个 loadUnit，那么相应目录和文件（如 app 和 config）都会被加载\n3. 自定义 Agent 上面的例子自定义了 Application，因为 Egg 是多进程模型，所以还需要定义 Agent，原理是一样的\n// lib/framework.js const path = require('path'); const egg = require('egg'); const EGG_PATH = Symbol.for('egg#eggPath'); class Application extends egg.Application { get [EGG_PATH]() { // 返回 framework 路径 return path.dirname(__dirname); } } class Agent extends egg.Agent { get [EGG_PATH]() { return path.dirname(__dirname); } } // 覆盖了 Egg 的 Application module.exports = Object.assign(egg, { Application, Agent, }); 但因为 Agent 和 Application 是两个实例，所以 API 有可能不一致\n4. 自定义 Loader Loader 应用启动的核心，使用它还能规范应用代码，我们可以基于这个类扩展更多功能，比如加载数据代码。\n扩展 Loader 还能覆盖默认的实现，或调整现有的加载顺序等\n自定义 Loader 也是用 Symbol.for(’egg#loader’) 的方式，主要的原因还是使用原型链\n// lib/framework.js const path = require('path'); const egg = require('egg'); const EGG_PATH = Symbol.for('egg#eggPath'); class AppWorkerLoader extends egg.AppWorkerLoader { load() { super.load(); // 自己扩展 } } class Application extends egg.Application { get [EGG_PATH]() { // 返回 framework 路径 return path.dirname(__dirname); } // 覆盖 Egg 的 Loader，启动时使用这个 Loader get [EGG_LOADER]() { return AppWorkerLoader; } } // 覆盖了 Egg 的 Application module.exports = Object.assign(egg, { Application, // 自定义的 Loader 也需要 export，上层框架需要基于这个扩展 AppWorkerLoader: AppWorkerLoader, }); AgentWorkerLoader 扩展也类似，这里不再举例\nAgentWorkerLoader 加载的文件可以于 AppWorkerLoader 不同，比如：默认加载时，Egg 的 AppWorkerLoader 会加载 app.js 而 AgentWorkerLoader 加载的是 agent.js。\n5. 拓展其他功能 你还可以自己去丰富plugins、middle等各种各样的功能特效，让你的Apr功能变得变得越来越强大，此处以plugins为例。\n内置 nunjucks 来提供服务端模板渲染能力 封装 egg-mysql // Apr 框架配置 // package.json { \"name\": \"apr\", \"version\": \"1.0.0\", \"dependencies\": { \"egg-mysql\": \"^3.0.0\", \"egg-view-nunjucks\": \"^2.0.0\" } } // config/plugin.js /** * @desc: framework 集成各种 plugins * @path: 'config/plugin.js' * */ module.exports = { // mysql mysql: { enable: false, package: 'egg-mysql', }, // add you build-in plugin here, example: nunjucks: { enable: false, package: 'egg-view-nunjucks', } } 使用Apr的应用配置:\n// 应用配置 // package.json { \"dependencies\": { \"apr\": \"^1.0.0\", } } // config/plugin.js module.exports = { // 开启插件 mysql: true, nunjucks: true, } 在框架的基础上还可以扩展出新的框架，也就是说框架是可以无限级继承的，有点像类的继承\n+-----------------------------------+--------+ | app1, app2, app3, app4 | | +-----+--------------+--------------+ | | | | framework2 | | + | Apr +--------------+ plugin | | | | framework1 | | + +--------------+--------------+ | | Egg | | +-----------------------------------+--------| | Koa | +-----------------------------------+--------+ 四、单元测试 待补充…\n可 参考\n五、框架启动原理 startCluster 启动传入 baseDir 和 framework，Master 进程启动 Master 先 fork Agent Worker 根据 framework 找到框架目录，实例化该框架的 Agent 类 Agent 找到定义的 AgentWorkerLoader，开始进行加载 AgentWorkerLoader，开始进行加载 整个加载过程是同步的，按 plugin \u003e config \u003e extend \u003e agent.js \u003e 其他文件顺序加载 agent.js 可自定义初始化，支持异步启动，如果定义了 beforeStart 会等待执行完成之后通知 Master 启动完成。 Master 得到 Agent Worker 启动成功的消息，使用 cluster fork App Worker App Worker 有多个进程，所以这几个进程是并行启动的，但执行逻辑是一致的 单个 App Worker 和 Agent 类似，通过 framework 找到框架目录，实例化该框架的 Application 类 Application 找到 AppWorkerLoader，开始进行加载，顺序也是类似的，会异步等待，完成后通知 Master 启动完成 Master 等待多个 App Worker 的成功消息后启动完成，能对外提供服务 六、Apr结构 Apr ├── README.md ├── app │ ├── extend │ │ ├── application.js │ │ └── context.js │ └── service │ └── test.js ├── config │ ├── config.default.js │ └── plugin.js ├── index.js ├── lib │ └── framework.js ├── package-lock.json ├── package.json └── test ├── fixtures │ └── example │ ├── app │ │ ├── controller │ │ │ └── home.js │ │ └── router.js │ ├── config │ │ └── config.default.js │ └── package.json └── framework.test.js 引用示例 demo源码仓库，欢迎 star。\n最后， 希望大家早日实现：成为编程高手的伟大梦想！ 欢迎交流~\n本文版权归原作者曜灵所有！未经允许，严禁转载！对非法转载者, 原作者保留采用法律手段追究的权利！ 若需转载，请联系微信公众号：连先生有猫病，可获取作者联系方式！\n","wordCount":"2483","inLanguage":"zh","datePublished":"2021-04-12T17:37:09+08:00","dateModified":"2021-04-12T17:37:09+08:00","author":{"@type":"Person","name":"曜灵"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://lianpf.github.io/posts/backend-develop/11.apr-framework-develop/"},"publisher":{"@type":"Organization","name":"曜灵（SUN）Site","logo":{"@type":"ImageObject","url":"https://lianpf.github.io/img-common/favicon.png"}}}</script></head><body id=top><script>(function(){let e,t=new RegExp("(^| )change-themes=([^;]*)(;|$)");(e=document.cookie.match(t))||((new Date).getHours()>=19||(new Date).getHours()<6?(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark")):(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")))})(),localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://lianpf.github.io/ accesskey=h title="曜灵（SUN）Site (Alt + H)"><img src=https://lianpf.github.io/img-common/avatar.jpeg alt=logo aria-label=logo height=35>曜灵（SUN）Site</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://lianpf.github.io/search title="🔍 搜索 (Alt + /)" accesskey=/><span>🔍 搜索</span></a></li><li><a href=https://lianpf.github.io/ title="🏠 主页"><span>🏠 主页</span></a></li><li><a href=https://lianpf.github.io/archives/ title="⏱️ 归档"><span>⏱️ 归档</span></a></li><li><a href=https://lianpf.github.io/tags title="🧩 标签"><span>🧩 标签</span></a></li><li><a href=https://lianpf.github.io/about title="🙋🏻‍♂️ 关于"><span>🙋🏻‍♂️ 关于</span></a></li></ul></nav></header><main class="main page"><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}</style><article class=post-single><div id=single-content><header class=post-header><div class=breadcrumbs><a href=https://lianpf.github.io/>🏠 主页</a>&nbsp;»&nbsp;<a href=https://lianpf.github.io/posts/>📚文章</a>&nbsp;»&nbsp;<a href=https://lianpf.github.io/posts/backend-develop/>🧱 后端开发</a></div><h1 class=post-title>Node: Apr框架开发</h1><div class=post-meta><style>i[id*=post_meta_style]{display:flex;align-items:center;margin:0 0 10px}.parent-post-meta{display:flex;flex-wrap:wrap;opacity:.8}</style><span class=parent-post-meta><span id=post_meta_style_1><span class="fa fa-calendar-check-o"></span>
<span>2021-04-12
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_3><span class="fa fa-file-word-o"></span>
<span>2483字
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_4><span class="fa fa-clock-o"></span>
<span>5分钟
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_5><span class="fa fa-user-o"></span>
<span>曜灵
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_6><span class="fa fa-tags" style=opacity:.8></span>
<span><span class=post-tags-meta><a href=https://lianpf.github.io/tags/node/ style=color:var(--secondary)!important>Node</a>
&nbsp;<a href=https://lianpf.github.io/tags/npm/ style=color:var(--secondary)!important>npm</a></span></span></span></span>
<span style=opacity:.8><span id=post_meta_style_7>&nbsp;&nbsp;
<span class="fa fa-eye"></span>
<span><span id=busuanzi_container_page_pv><span id=busuanzi_value_page_pv></span></span>
&nbsp;&nbsp;</span></span>
<span id=post_meta_style_8><span class="fa fa-commenting-o"></span>
<span><script src=https://cdn.staticfile.org/twikoo/1.5.8/twikoo.all.min.js></script>
<script>let url=document.documentURI,dnsUrl="https://lianpf.github.io/",urlSplit=url.split(dnsUrl),finalUrl=urlSplit[1];finalUrl[0]!=="/"&&(finalUrl="/"+finalUrl),twikoo.getCommentsCount({envId:null,region:null,urls:[finalUrl],includeReply:!1}).then(function(e){let t=e[0].count;const n=document.getElementById("comment_count");n.innerText=t}).catch(function(e){console.error(e)})</script><span id=comment_count></span></span></span></span></div></header><aside id=toc-container class="toc-container wide"><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>目录</span></summary><div class=inner><ul><li><a href=#%e4%b8%80%e8%83%8c%e6%99%af aria-label=一、背景>一、背景</a></li><li><a href=#%e4%ba%8c%e6%a1%86%e6%9e%b6%e4%b8%8e%e5%a4%9a%e8%bf%9b%e7%a8%8b aria-label=二、框架与多进程>二、框架与多进程</a></li><li><a href=#%e4%b8%89%e5%ae%9a%e5%88%b6%e6%a1%86%e6%9e%b6-apr aria-label="三、定制框架: Apr">三、定制框架: Apr</a><ul><li><a href=#1-create-apr--init aria-label="1. create Apr &amp;amp; init">1. create Apr & init</a></li><li><a href=#2-%e6%a1%86%e6%9e%b6%e7%bb%a7%e6%89%bf aria-label="2. 框架继承">2. 框架继承</a></li><li><a href=#3-%e8%87%aa%e5%ae%9a%e4%b9%89-agent aria-label="3. 自定义 Agent">3. 自定义 Agent</a></li><li><a href=#4-%e8%87%aa%e5%ae%9a%e4%b9%89-loader aria-label="4. 自定义 Loader">4. 自定义 Loader</a></li><li><a href=#5-%e6%8b%93%e5%b1%95%e5%85%b6%e4%bb%96%e5%8a%9f%e8%83%bd aria-label="5. 拓展其他功能">5. 拓展其他功能</a></li></ul></li><li><a href=#%e5%9b%9b%e5%8d%95%e5%85%83%e6%b5%8b%e8%af%95 aria-label=四、单元测试>四、单元测试</a></li><li><a href=#%e4%ba%94%e6%a1%86%e6%9e%b6%e5%90%af%e5%8a%a8%e5%8e%9f%e7%90%86 aria-label=五、框架启动原理>五、框架启动原理</a></li><li><a href=#%e5%85%adapr%e7%bb%93%e6%9e%84 aria-label=六、Apr结构>六、<code>Apr</code>结构</a></li><li><a href=#%e5%bc%95%e7%94%a8%e7%a4%ba%e4%be%8b aria-label=引用示例>引用示例</a></li></ul></div></details></div></aside><script>let activeElement,elements;window.addEventListener("DOMContentLoaded",function(){checkTocPosition(),elements=document.querySelectorAll("h1[id],h2[id],h3[id],h4[id],h5[id],h6[id]"),activeElement=elements[0];const t=encodeURI(activeElement.getAttribute("id")).toLowerCase();document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active")},!1),window.addEventListener("resize",function(){checkTocPosition()},!1),window.addEventListener("scroll",()=>{elements&&(activeElement=Array.from(elements).find(e=>{if(getOffsetTop(e)-window.pageYOffset>0&&getOffsetTop(e)-window.pageYOffset<window.innerHeight/2)return e})||activeElement,elements.forEach(e=>{const t=encodeURI(e.getAttribute("id")).toLowerCase();e===activeElement?document.querySelector(`.inner ul li a[href="#${t}"]`).classList.add("active"):document.querySelector(`.inner ul li a[href="#${t}"]`).classList.remove("active")}))},!1);const main=parseInt(getComputedStyle(document.body).getPropertyValue("--article-width"),10),toc=parseInt(getComputedStyle(document.body).getPropertyValue("--toc-width"),10),gap=parseInt(getComputedStyle(document.body).getPropertyValue("--gap"),10);function checkTocPosition(){const e=document.body.scrollWidth;e-main-toc*2-gap*4>0?document.getElementById("toc-container").classList.add("wide"):document.getElementById("toc-container").classList.remove("wide")}function getOffsetTop(e){if(!e.getClientRects().length)return 0;let t=e.getBoundingClientRect(),n=e.ownerDocument.defaultView;return t.top+n.pageYOffset}</script><div class=post-content><p>在低代码平台开发过程，由于物料管理系统以及Node Server 中间层的搭建使用过程中，发现很多通用的库和配置可以&mldr;</p><h2 id=一背景>一、背景<a hidden class=anchor aria-hidden=true href=#一背景>#</a></h2><p>在低代码平台开发过程，由于物料管理系统以及Node Server 中间层的搭建使用过程中，发现很多通用的库和配置可以沉淀，形成可复制的解决方案。所以，基于开源框架Egg.js（基于Koa2）进行了拓展封装形成了初版Apr。</p><p>整个团队依赖初版Apr作为统一的Node方案，随着业务场景越来越丰富，一些插件、middle等公共配置成为最佳实践后，逐渐下沉到Apr框架中，让Apr越来越成熟。而后，依赖Apr的其他项目仅需简单的升级下框架的版本即可享受到Apr带来的红利。</p><p>如果你的团队也在考虑搭建类似的框架，那么请考虑如下问题：</p><ul><li>如果你的团队遇到过：<ul><li>维护很多个项目，每个项目都需要复制拷贝诸如 <code>gulpfile.js</code> / <code>webpack.config.js</code> 之类的文件</li><li>每个项目都需要使用一些相同的类库，相同的配置</li><li>在新项目中对上面的配置做了一个优化后，如何同步到其他项目？</li></ul></li><li>如果你的团队需要：<ul><li>统一的技术选型，比如数据库、模板、前端框架及各种中间件设施都需要选型，而框架封装后保证应用使用一套架构</li><li>统一的默认配置，开源社区的配置可能不适用于公司，而又不希望应用去配置</li><li>统一的部署方案，通过框架和平台的双向控制，应用只需要关注自己的代码，具体查看<a href=https://eggjs.org/zh-cn/core/deployment.html>应用部署</a></li><li>统一的代码风格，框架不仅仅解决代码重用问题，还可以对应用做一定约束，作为企业框架是很必要的。Apr依赖于 Egg, Egg 在 Koa 基础上做了很多约定，框架可以使用 <a href=https://eggjs.org/zh-cn/advanced/loader.html>Loader</a> 自己定义代码规则</li></ul></li></ul><p>如果需要，以下是Apr的简易版搭建过程，也许对你有所帮助:</p><blockquote><p>稳定成熟版涉及到公司相关业务，故仅存内网中，不对外暴露，请勿私聊获取</p></blockquote><h2 id=二框架与多进程>二、框架与多进程<a hidden class=anchor aria-hidden=true href=#二框架与多进程>#</a></h2><p>框架的扩展是和多进程模型有关的，我们已经知道多进程模型，我们需要扩展的类有 Agent 和 Application。</p><p>在 Agent Worker 启动的时候会实例化 Agent，而在 App Worker 启动时会实例化 Application，这两个类又同时继承 EggCore。</p><p>EggCore 可以看做 Koa Application 的升级版，默认内置 Loader、Router 及应用异步启动等功能，可以看做是支持 Loader 的 Koa。
而我们要搭建的Apr则依赖于EggCore。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>      Koa Application
</span></span><span style=display:flex><span>             ^
</span></span><span style=display:flex><span>          EggCore
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>             ^
</span></span><span style=display:flex><span>          AprCore
</span></span><span style=display:flex><span>             ^
</span></span><span style=display:flex><span>      ┌──────┴───────┐
</span></span><span style=display:flex><span>      │              │
</span></span><span style=display:flex><span>  Apr Agent      Apr Application
</span></span><span style=display:flex><span>     ^               ^
</span></span><span style=display:flex><span>agent worker     app worker
</span></span></code></pre></div><h2 id=三定制框架-apr>三、定制框架: Apr<a hidden class=anchor aria-hidden=true href=#三定制框架-apr>#</a></h2><h3 id=1-create-apr--init>1. create Apr & init<a hidden class=anchor aria-hidden=true href=#1-create-apr--init>#</a></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>$ mkdir apr &amp;&amp; cd apr
</span></span><span style=display:flex><span>$ npm init egg --type=framework
</span></span><span style=display:flex><span>$ npm i
</span></span><span style=display:flex><span>$ npm test
</span></span></code></pre></div><h3 id=2-框架继承>2. 框架继承<a hidden class=anchor aria-hidden=true href=#2-框架继承>#</a></h3><p>框架支持继承关系，可以把框架比作一个类，基类是 Egg 框架，定义一个框架需要继承于Egg且实现 Egg 所有的 API。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// package.json
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;name&#34;: &#34;apr&#34;,
</span></span><span style=display:flex><span>  &#34;dependencies&#34;: {
</span></span><span style=display:flex><span>    &#34;egg&#34;: &#34;^2.0.0&#34;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// index.js
</span></span><span style=display:flex><span>module.exports = require(&#39;./lib/framework.js&#39;);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// lib/framework.js
</span></span><span style=display:flex><span>const path = require(&#39;path&#39;);
</span></span><span style=display:flex><span>const egg = require(&#39;egg&#39;);
</span></span><span style=display:flex><span>const EGG_PATH = Symbol.for(&#39;egg#eggPath&#39;);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class Application extends egg.Application {
</span></span><span style=display:flex><span>  get [EGG_PATH]() {
</span></span><span style=display:flex><span>    // 返回 framework 路径
</span></span><span style=display:flex><span>    return path.dirname(__dirname);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// 覆盖了 Egg 的 Application
</span></span><span style=display:flex><span>module.exports = Object.assign(egg, {
</span></span><span style=display:flex><span>  Application,
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>应用启动时需要指定框架名（在 package.json 指定 egg.framework，默认为 egg），Loader 将从 node_modules 找指定模块作为框架，并加载其 export 的 Application</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;scripts&#34;: {
</span></span><span style=display:flex><span>    &#34;dev&#34;: &#34;egg-bin dev&#34;
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  &#34;egg&#34;: {
</span></span><span style=display:flex><span>    &#34;framework&#34;: &#34;apr&#34;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>现在 <code>apr</code> 框架目录已经是一个 loadUnit，那么相应目录和文件（如 app 和 config）都会被加载</p><h3 id=3-自定义-agent>3. 自定义 Agent<a hidden class=anchor aria-hidden=true href=#3-自定义-agent>#</a></h3><p>上面的例子自定义了 Application，因为 Egg 是多进程模型，所以还需要定义 Agent，原理是一样的</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// lib/framework.js
</span></span><span style=display:flex><span>const path = require(&#39;path&#39;);
</span></span><span style=display:flex><span>const egg = require(&#39;egg&#39;);
</span></span><span style=display:flex><span>const EGG_PATH = Symbol.for(&#39;egg#eggPath&#39;);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class Application extends egg.Application {
</span></span><span style=display:flex><span>  get [EGG_PATH]() {
</span></span><span style=display:flex><span>    // 返回 framework 路径
</span></span><span style=display:flex><span>    return path.dirname(__dirname);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class Agent extends egg.Agent {
</span></span><span style=display:flex><span>  get [EGG_PATH]() {
</span></span><span style=display:flex><span>    return path.dirname(__dirname);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// 覆盖了 Egg 的 Application
</span></span><span style=display:flex><span>module.exports = Object.assign(egg, {
</span></span><span style=display:flex><span>  Application,
</span></span><span style=display:flex><span>  Agent,
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><blockquote><p>但因为 Agent 和 Application 是两个实例，所以 API 有可能不一致</p></blockquote><h3 id=4-自定义-loader>4. 自定义 Loader<a hidden class=anchor aria-hidden=true href=#4-自定义-loader>#</a></h3><p>Loader 应用启动的核心，使用它还能规范应用代码，我们可以基于这个类扩展更多功能，比如加载数据代码。</p><blockquote><p>扩展 Loader 还能覆盖默认的实现，或调整现有的加载顺序等</p></blockquote><blockquote><p>自定义 Loader 也是用 Symbol.for(&rsquo;egg#loader&rsquo;) 的方式，主要的原因还是使用原型链</p></blockquote><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// lib/framework.js
</span></span><span style=display:flex><span>const path = require(&#39;path&#39;);
</span></span><span style=display:flex><span>const egg = require(&#39;egg&#39;);
</span></span><span style=display:flex><span>const EGG_PATH = Symbol.for(&#39;egg#eggPath&#39;);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class AppWorkerLoader extends egg.AppWorkerLoader {
</span></span><span style=display:flex><span>  load() {
</span></span><span style=display:flex><span>    super.load();
</span></span><span style=display:flex><span>    // 自己扩展
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>class Application extends egg.Application {
</span></span><span style=display:flex><span>  get [EGG_PATH]() {
</span></span><span style=display:flex><span>    // 返回 framework 路径
</span></span><span style=display:flex><span>    return path.dirname(__dirname);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  // 覆盖 Egg 的 Loader，启动时使用这个 Loader
</span></span><span style=display:flex><span>  get [EGG_LOADER]() {
</span></span><span style=display:flex><span>    return AppWorkerLoader;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// 覆盖了 Egg 的 Application
</span></span><span style=display:flex><span>module.exports = Object.assign(egg, {
</span></span><span style=display:flex><span>  Application,
</span></span><span style=display:flex><span>  // 自定义的 Loader 也需要 export，上层框架需要基于这个扩展
</span></span><span style=display:flex><span>  AppWorkerLoader: AppWorkerLoader,
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>AgentWorkerLoader 扩展也类似，这里不再举例</p><blockquote><p>AgentWorkerLoader 加载的文件可以于 AppWorkerLoader 不同，比如：默认加载时，Egg 的 AppWorkerLoader 会加载 app.js 而 AgentWorkerLoader 加载的是 agent.js。</p></blockquote><h3 id=5-拓展其他功能>5. 拓展其他功能<a hidden class=anchor aria-hidden=true href=#5-拓展其他功能>#</a></h3><p>你还可以自己去丰富plugins、middle等各种各样的功能特效，让你的<code>Apr</code>功能变得变得越来越强大，此处以plugins为例。</p><ul><li>内置 <code>nunjucks</code> 来提供服务端模板渲染能力</li><li>封装 <code>egg-mysql</code></li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// Apr 框架配置
</span></span><span style=display:flex><span>// package.json
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;name&#34;: &#34;apr&#34;,
</span></span><span style=display:flex><span>  &#34;version&#34;: &#34;1.0.0&#34;,
</span></span><span style=display:flex><span>  &#34;dependencies&#34;: {
</span></span><span style=display:flex><span>    &#34;egg-mysql&#34;: &#34;^3.0.0&#34;,
</span></span><span style=display:flex><span>    &#34;egg-view-nunjucks&#34;: &#34;^2.0.0&#34;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// config/plugin.js
</span></span><span style=display:flex><span>/**
</span></span><span style=display:flex><span> * @desc: framework 集成各种 plugins
</span></span><span style=display:flex><span> * @path: &#39;config/plugin.js&#39;
</span></span><span style=display:flex><span> * */
</span></span><span style=display:flex><span>module.exports = {
</span></span><span style=display:flex><span>  // mysql
</span></span><span style=display:flex><span>  mysql: {
</span></span><span style=display:flex><span>    enable: false,
</span></span><span style=display:flex><span>    package: &#39;egg-mysql&#39;,
</span></span><span style=display:flex><span>  },
</span></span><span style=display:flex><span>  // add you build-in plugin here, example:
</span></span><span style=display:flex><span>  nunjucks: {
</span></span><span style=display:flex><span>    enable: false,
</span></span><span style=display:flex><span>    package: &#39;egg-view-nunjucks&#39;,
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>使用Apr的应用配置:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// 应用配置
</span></span><span style=display:flex><span>// package.json
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  &#34;dependencies&#34;: {
</span></span><span style=display:flex><span>    &#34;apr&#34;: &#34;^1.0.0&#34;,
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>// config/plugin.js
</span></span><span style=display:flex><span>module.exports = {
</span></span><span style=display:flex><span>  // 开启插件
</span></span><span style=display:flex><span>  mysql: true,
</span></span><span style=display:flex><span>  nunjucks: true,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在框架的基础上还可以扩展出新的框架，也就是说框架是可以无限级继承的，有点像类的继承</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>+-----------------------------------+--------+
</span></span><span style=display:flex><span>|      app1, app2, app3, app4       |        |
</span></span><span style=display:flex><span>+-----+--------------+--------------+        |
</span></span><span style=display:flex><span>|     |              |  framework2  |        |
</span></span><span style=display:flex><span>+     |       Apr    +--------------+ plugin |
</span></span><span style=display:flex><span>|     |              |  framework1  |        |
</span></span><span style=display:flex><span>+     +--------------+--------------+        |
</span></span><span style=display:flex><span>|                   Egg             |        |
</span></span><span style=display:flex><span>+-----------------------------------+--------|
</span></span><span style=display:flex><span>|                   Koa                      |
</span></span><span style=display:flex><span>+-----------------------------------+--------+
</span></span></code></pre></div><h2 id=四单元测试>四、单元测试<a hidden class=anchor aria-hidden=true href=#四单元测试>#</a></h2><blockquote><p>待补充&mldr;</p></blockquote><p>可 <a href=https://zhuanlan.zhihu.com/p/154643011>参考</a></p><h2 id=五框架启动原理>五、框架启动原理<a hidden class=anchor aria-hidden=true href=#五框架启动原理>#</a></h2><ul><li>startCluster 启动传入 baseDir 和 framework，Master 进程启动</li><li>Master 先 fork Agent Worker<ul><li>根据 framework 找到框架目录，实例化该框架的 Agent 类</li><li>Agent 找到定义的 AgentWorkerLoader，开始进行加载</li><li>AgentWorkerLoader，开始进行加载 整个加载过程是同步的，按 plugin > config > extend > agent.js > 其他文件顺序加载</li><li>agent.js 可自定义初始化，支持异步启动，如果定义了 beforeStart 会等待执行完成之后通知 Master 启动完成。</li></ul></li><li>Master 得到 Agent Worker 启动成功的消息，使用 cluster fork App Worker<ul><li>App Worker 有多个进程，所以这几个进程是并行启动的，但执行逻辑是一致的</li><li>单个 App Worker 和 Agent 类似，通过 framework 找到框架目录，实例化该框架的 Application 类</li><li>Application 找到 AppWorkerLoader，开始进行加载，顺序也是类似的，会异步等待，完成后通知 Master 启动完成</li></ul></li><li>Master 等待多个 App Worker 的成功消息后启动完成，能对外提供服务</li></ul><h2 id=六apr结构>六、<code>Apr</code>结构<a hidden class=anchor aria-hidden=true href=#六apr结构>#</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>Apr
</span></span><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>├── app
</span></span><span style=display:flex><span>│   ├── extend
</span></span><span style=display:flex><span>│   │   ├── application.js
</span></span><span style=display:flex><span>│   │   └── context.js
</span></span><span style=display:flex><span>│   └── service
</span></span><span style=display:flex><span>│       └── test.js
</span></span><span style=display:flex><span>├── config
</span></span><span style=display:flex><span>│   ├── config.default.js
</span></span><span style=display:flex><span>│   └── plugin.js
</span></span><span style=display:flex><span>├── index.js
</span></span><span style=display:flex><span>├── lib
</span></span><span style=display:flex><span>│   └── framework.js
</span></span><span style=display:flex><span>├── package-lock.json
</span></span><span style=display:flex><span>├── package.json
</span></span><span style=display:flex><span>└── test
</span></span><span style=display:flex><span>    ├── fixtures
</span></span><span style=display:flex><span>    │   └── example
</span></span><span style=display:flex><span>    │       ├── app
</span></span><span style=display:flex><span>    │       │   ├── controller
</span></span><span style=display:flex><span>    │       │   │   └── home.js
</span></span><span style=display:flex><span>    │       │   └── router.js
</span></span><span style=display:flex><span>    │       ├── config
</span></span><span style=display:flex><span>    │       │   └── config.default.js
</span></span><span style=display:flex><span>    │       └── package.json
</span></span><span style=display:flex><span>    └── framework.test.js
</span></span></code></pre></div><hr><h2 id=引用示例>引用示例<a hidden class=anchor aria-hidden=true href=#引用示例>#</a></h2><p><a href=https://github.com/lianpf/examples/tree/master/node/apr-example>demo源码仓库</a>，欢迎 <code>star</code>。</p><hr><p><strong>最后， 希望大家早日实现：成为编程高手的伟大梦想！</strong><br><strong>欢迎交流~</strong></p><img src=/img-common/weChatPublic.jpg alt=微信公众号 width=600 height=286><p><strong>本文版权归原作者曜灵所有！未经允许，严禁转载！对非法转载者, 原作者保留采用法律手段追究的权利！</strong><br><strong>若需转载，请联系微信公众号：连先生有猫病，可获取作者联系方式！</strong></p></div><footer class=post-footer><nav class=paginav><a class=prev href=https://lianpf.github.io/posts/backend-develop/12.apr-framework-docs/><span class=title>« 上一页</span><br><span>Node: Apr框架使用文档</span></a>
<a class=next href=https://lianpf.github.io/posts/other/11.mysql-gui/><span class=title>下一页 »</span><br><span>MySQL 8.0问题排查</span></a></nav><div class=share-buttons><a target=_blank rel="noopener noreferrer" aria-label="share Node: Apr框架开发 on twitter" href="https://twitter.com/intent/tweet/?text=Node%3a%20Apr%e6%a1%86%e6%9e%b6%e5%bc%80%e5%8f%91&amp;url=https%3a%2f%2flianpf.github.io%2fposts%2fbackend-develop%2f11.apr-framework-develop%2f&amp;hashtags=Node%2cnpm"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM195.519 424.544c135.939.0 210.268-112.643 210.268-210.268.0-3.218.0-6.437-.153-9.502 14.406-10.421 26.973-23.448 36.935-38.314-13.18 5.824-27.433 9.809-42.452 11.648 15.326-9.196 26.973-23.602 32.49-40.92-14.252 8.429-30.038 14.56-46.896 17.931-13.487-14.406-32.644-23.295-53.946-23.295-40.767.0-73.87 33.104-73.87 73.87.0 5.824.613 11.494 1.992 16.858-61.456-3.065-115.862-32.49-152.337-77.241-6.284 10.881-9.962 23.601-9.962 37.088.0 25.594 13.027 48.276 32.95 61.456-12.107-.307-23.448-3.678-33.41-9.196v.92c0 35.862 25.441 65.594 59.311 72.49-6.13 1.686-12.72 2.606-19.464 2.606-4.751.0-9.348-.46-13.946-1.38 9.349 29.426 36.628 50.728 68.965 51.341-25.287 19.771-57.164 31.571-91.8 31.571-5.977.0-11.801-.306-17.625-1.073 32.337 21.15 71.264 33.41 112.95 33.41z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Node: Apr框架开发 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2flianpf.github.io%2fposts%2fbackend-develop%2f11.apr-framework-develop%2f&amp;title=Node%3a%20Apr%e6%a1%86%e6%9e%b6%e5%bc%80%e5%8f%91&amp;summary=Node%3a%20Apr%e6%a1%86%e6%9e%b6%e5%bc%80%e5%8f%91&amp;source=https%3a%2f%2flianpf.github.io%2fposts%2fbackend-develop%2f11.apr-framework-develop%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Node: Apr框架开发 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2flianpf.github.io%2fposts%2fbackend-develop%2f11.apr-framework-develop%2f&title=Node%3a%20Apr%e6%a1%86%e6%9e%b6%e5%bc%80%e5%8f%91"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Node: Apr框架开发 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2flianpf.github.io%2fposts%2fbackend-develop%2f11.apr-framework-develop%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Node: Apr框架开发 on whatsapp" href="https://api.whatsapp.com/send?text=Node%3a%20Apr%e6%a1%86%e6%9e%b6%e5%bc%80%e5%8f%91%20-%20https%3a%2f%2flianpf.github.io%2fposts%2fbackend-develop%2f11.apr-framework-develop%2f"><svg viewBox="0 0 512 512"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a><a target=_blank rel="noopener noreferrer" aria-label="share Node: Apr框架开发 on telegram" href="https://telegram.me/share/url?text=Node%3a%20Apr%e6%a1%86%e6%9e%b6%e5%bc%80%e5%8f%91&amp;url=https%3a%2f%2flianpf.github.io%2fposts%2fbackend-develop%2f11.apr-framework-develop%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></div></footer></div><script src=https://utteranc.es/client.js repo=lianpf/lianpf.github.io issue-term=title label=comments theme=github-light crossorigin=anonymous async></script></article></main><footer class=footer><span>Copyright
&copy;
2016-2024
<a href=https://lianpf.github.io/ style=color:#939393>曜灵（SUN）Site</a>.
基于 Hugo 引擎和 PaperMod 主题</span>
<a href=https://beian.miit.gov.cn/ target=_blank style=color:#939393></a>&nbsp;</footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><span class=topInner><svg class="topSvg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg><span id=read_progress></span></span></a>
<script>document.addEventListener("scroll",function(){const t=document.getElementById("read_progress"),n=document.documentElement.scrollHeight,s=document.documentElement.clientHeight,o=document.documentElement.scrollTop||document.body.scrollTop;t.innerText=((o/(n-s)).toFixed(2)*100).toFixed(0)})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>let mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>200||document.documentElement.scrollTop>200?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{(function(){document.cookie="change-themes="+escape("false")})(),document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.body.addEventListener("copy",function(e){if(window.getSelection().toString()&&window.getSelection().toString().length>50){let t=e.clipboardData||window.clipboardData;if(t){e.preventDefault();let n=window.getSelection().toString()+`

————————————————
版权声明：本文为「曜灵（SUN）Site」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href,s=window.getSelection().toString()+`

————————————————
版权声明：本文为「曜灵（SUN）Site」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href;t.setData("text/html",n),t.setData("text/plain",s)}}})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const s=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerText="复制";function i(){t.innerText="已复制！",setTimeout(()=>{t.innerText="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){let t=e.textContent+`
————————————————
版权声明：本文为「曜灵（SUN）Site」的原创文章，遵循CC 4.0 BY-SA版权协议，转载请附上原文出处链接及本声明。
原文链接：`+location.href;navigator.clipboard.writeText(t),i();return}const n=document.createRange();n.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(n);try{document.execCommand("copy"),i()}catch{}s.removeRange(n)});let l=e.className.replaceAll("language-",""),n=document.createElement("div"),a=document.createElement("div"),r=document.createElement("div"),c=document.createElement("div"),o=document.createElement("div");o.innerText=l,n.setAttribute("class","mac-tool"),a.setAttribute("class","mac bb1"),r.setAttribute("class","mac bb2"),c.setAttribute("class","mac bb3"),o.setAttribute("class","language-type"),n.appendChild(a),n.appendChild(r),n.appendChild(c),n.appendChild(o),s.classList.contains("highlight")?(s.appendChild(t),s.appendChild(n)):s.parentNode.firstChild==s||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?(e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t),s.appendChild(n)):(e.parentNode.appendChild(t),s.appendChild(n)))})</script></body></html>